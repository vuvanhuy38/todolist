<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Todo List</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .table-fixed {
            table-layout: fixed;
            width: 100%;
        }

        .table-fixed th,
        .table-fixed td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-fixed td:nth-child(2) {
            white-space: normal;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="bg-light">
<div class="container mt-4">
    <h2>Todo List</h2>

    <a href="/create" class="btn btn-primary mb-3">Add Todo</a>

    <table class="table table-bordered table-fixed">
        <thead>
        <tr>
            <th style="width: 20%;">Title</th>
            <th style="width: 35%;">Description</th>
            <th style="width: 15%;">Completed</th>
            <th style="width: 30%;">Actions</th>
        </tr>
        </thead>
        <tbody id="todo-body"></tbody>
    </table>

    <!-- PhÃ¢n trang -->
    <nav>
        <ul class="pagination" id="pagination"></ul>
    </nav>

</div>

<script>
    let pageSize = 5;
    let currentPage = 0;

    async function loadTodos(page = 0) {
        currentPage = page;

        const res = await fetch(`/api/todos?page=${page}&size=${pageSize}`);
        const data = await res.json();

        const todos = data.content;
        const totalPages = data.totalPages;
        const totalItems = data.totalElements;

        const body = document.getElementById("todo-body");
        body.innerHTML = "";

        todos.forEach(todo => {
            body.innerHTML += `
                <tr>
                    <td>${todo.title}</td>
                    <td>${todo.description}</td>
                    <td>
                        ${todo.completed ?
                '<span class="badge bg-success">Done</span>' :
                '<span class="badge bg-secondary">Pending</span>'}
                    </td>
                    <td>
                        <a href="/detail?id=${todo.id}" class="btn btn-info btn-sm">Detail</a>
                        <a href="/edit?id=${todo.id}" class="btn btn-sm btn-warning">Edit</a>
                        <button onclick="toggle('${todo.id}')" class="btn btn-sm btn-info">Toggle</button>
                        <button onclick="removeTodo('${todo.id}')" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>
            `;
        });

        // Render pagination
        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        // Prev
        pagination.innerHTML += `
            <li class="page-item ${currentPage === 0 ? "disabled" : ""}">
                <button class="page-link" onclick="loadTodos(${currentPage - 1})">&laquo;</button>
            </li>
        `;

        // Number buttons
        for (let i = 0; i < totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${currentPage === i ? "active" : ""}">
                    <button class="page-link" onclick="loadTodos(${i})">${i + 1}</button>
                </li>
            `;
        }

        // Next
        pagination.innerHTML += `
            <li class="page-item ${currentPage >= totalPages - 1 ? "disabled" : ""}">
                <button class="page-link" onclick="loadTodos(${currentPage + 1})">&raquo;</button>
            </li>
        `;
    }

    async function removeTodo(id) {
        await fetch(`/api/todos/${id}`, { method: "DELETE" });
        loadTodos(currentPage);
    }

    async function toggle(id) {
        await fetch(`/api/todos/${id}/toggle`, { method: "PATCH" });
        loadTodos(currentPage);
    }

    loadTodos();
</script>
</body>
</html>